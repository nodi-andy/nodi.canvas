/** @license SPDX-License-Identifier: MIT */
!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports):"function"==typeof define&&define.amd?define(["exports"],s):s((t="undefined"!=typeof globalThis?globalThis:t||self).nodicanvas={})}(this,(function(t){"use strict";class s{constructor(t,s){this.x=t||0,this.y=s||0}invert(){return this.x=-this.x,this.y=-this.y,this}add(t){return t instanceof s?(this.x+=t.x,this.y+=t.y):(this.x+=t,this.y+=t),this}subtract(t){return t instanceof s?(this.x-=t.x,this.y-=t.y):(this.x-=t,this.y-=t),this}multiply(t){return t instanceof s?(this.x*=t.x,this.y*=t.y):(this.x*=t,this.y*=t),this}divide(t){return t instanceof s?(0!=t.x&&(this.x/=t.x),0!=t.y&&(this.y/=t.y)):0!=t&&(this.x/=t,this.y/=t),this}equals(t){return this.x==t.x&&this.y==t.y}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}length(){return Math.sqrt(this.dot(this))}normalize(){return this.divide(this.length())}min(){return Math.min(this.x,this.y)}max(){return Math.max(this.x,this.y)}toAngles(){return-Math.atan2(-this.y,this.x)}angleTo(t){return Math.acos(this.dot(t)/(this.length()*t.length()))}toArray(t){return[this.x,this.y].slice(0,t||2)}clone(){return new s(this.x,this.y)}set(t,s){return this.x=t,this.y=s,this}}s.invert=function(t){return new s(-t.x,-t.y)},s.add=function(t,i){return i instanceof s?new s(t.x+i.x,t.y+i.y):new s(t.x+i,t.y+i)},s.subtract=function(t,i){return i instanceof s?new s(t.x-i.x,t.y-i.y):new s(t.x-i,t.y-i)},s.multiply=function(t,i){return i instanceof s?new s(t.x*i.x,t.y*i.y):new s(t.x*i,t.y*i)},s.divide=function(t,i){return i instanceof s?new s(t.x/i.x,t.y/i.y):new s(t.x/i,t.y/i)},s.equals=function(t,s){return t.x==s.x&&t.y==s.y},s.dot=function(t,s){return t.x*s.x+t.y*s.y},s.cross=function(t,s){return t.x*s.y-t.y*s.x},s.distance=function(t,i){let e,n;t instanceof s==0&&(e=new s(t[0],t[1])),i instanceof s==0&&(n=new s(i[0],i[1]));const h=e.subtract(n);return Math.sqrt(h[0]*h[0]+h[1]*h[1])},s.getRandom=function(t,i){return new s(Math.getRandomInt(t),Math.getRandomInt(i))};class i{constructor(t){this.sx=1,this.sy=this.sx,this.tx=0,this.ty=0,this.dx=0,this.dy=0,this.scale=this.sx,t?.length&&(this.max_scale=t[0]),t?.length&&(this.min_scale=t[1]),this.enabled=!0,this.element=null}toWorld(t){return new s((t.x+this.tx)*this.scale,(t.y+this.ty)*this.scale)}toCanvas(t){return new s(this.tx+t.x/this.scale,this.ty+t.y/this.scale)}setTranslate(t,s){this.tx=t,this.ty=s}setScale(t,i){if(null!=this.min_scale&&t<this.min_scale?t=this.min_scale:null!=this.max_scale&&t>this.max_scale&&(t=this.max_scale),t!=this.scale){if(this.scale=t,i){var e=this.toCanvas(i);this.scale=t,Math.abs(this.scale-1)<.01&&(this.scale=1);var n=this.toCanvas(i),h=new s(n[0]-e[0],n[1]-e[1]);this.tx+=h.x,this.ty+=h.y}this.sx=this.sy=this.scale}}changeDeltaScale(t,s){this.setScale(this.scale*t,s)}reset(){this.scale=1,this.tx=0,this.ty=0}}class e extends i{constructor(t,s){super(),this.name=t,this.viewPort=new DOMRect(4),this.pointerevents_method="mouse",this.visible=!0,this.zIndex=s}attachView(t){this.view=t,this.updateViewPort()}updateViewPort(){if(this.view){var t=this.tx-(this.view.tx+this.view.dx),s=this.ty-(this.view.ty+this.view.dy);this.viewPort.x=t,this.viewPort.y=s,this.viewPort.width=this.view.canvas.width*this.scale/this.view.scale,this.viewPort.height=this.view.canvas.height*this.scale/this.view.scale}else this.viewPort.x=0,this.viewPort.y=0,this.viewPort.width=this.canvas.width,this.viewPort.height=this.canvas.height}fillText(t,s){this.view.ctx.fillText(t,s.x+.5,s.y+.75)}}class n extends e{constructor(t,s,i,e){super(t),s&&(this.gridSize=s.clone()),this.tileSize=i,this.lineWidth=e,this.setGridScale(this.gridSize),this.gridSize&&(this.mid=this.gridSize.clone().divide(2),this.size=this.gridSize.clone().multiply(this.tileSize),this.ratio=this.size.x/this.size.y)}extendMouseData(t){t.canvasX=(t.clientX-this.view.tx)/this.view.scale,t.canvasY=(t.clientY-this.view.ty)/this.view.scale,t.gridX=Math.floor(t.canvasX/this.tileSize),t.gridY=Math.floor(t.canvasY/this.tileSize)}setGridScale(t){this.gridScale=t}worldToTileXY(t,i){return new s(Math.floor(t/this.tileSize),Math.floor(i/this.tileSize))}worldToTile(t){return this.worldToTileXY(t.x,t.y)}screenToTile(t){if(this.view){let s=this.view.screenToWorld(t);return this.worldToTile(s)}}renderGrid(t){t.ctx.strokeStyle="#555";let s,i;s=0==this.w||null==this.w?0+this.gridSize.x:this.w,i=0==this.h||null==this.h?0+this.gridSize.y:this.h,t.ctx.shadowColor="black",t.ctx.shadowBlur=20,t.ctx.fillStyle="rgb(234, 234, 234)",t.ctx.fillRect(0,0,s,i),t.ctx.shadowColor="rgba(0,0,0,0)",t.ctx.lineWidth=this.lineWidth,t.ctx.beginPath();for(var e=0;e<=s;e+=1)t.ctx.moveTo(e,0),t.ctx.lineTo(e,i);for(var n=0;n<=i;n+=1)t.ctx.moveTo(0,n),t.ctx.lineTo(s,n);t.ctx.stroke()}}class h{constructor(t){this.dragable=!1,this.setView(t),this.draggingCanvas=!1,this.pointerDown=!1,this.pointerIsDouble=!1,this.mouseStartCanvas=new s(0,0),this.mouseCurrentCanvas=new s(0,0)}setView(t){t&&t!==this.view&&(this.view=t,this.canvas=t.canvas,this._mousedown_callback=this.onMouseDown.bind(this),this._mousewheel_callback=this.onMouseWheel.bind(this),this._mousemove_callback=this.onMouseMove.bind(this),this._mouseup_callback=this.onMouseUp.bind(this),this._keydown_callback=this.onKeyDown.bind(this),this._keyup_callback=this.onKeyUp.bind(this),canvas.addEventListener("wheel",this._mousewheel_callback,!1),canvas.addEventListener("mousedown",this._mousedown_callback,!1),canvas.addEventListener("mouseup",this._mouseup_callback,!1),canvas.addEventListener("mousemove",this._mousemove_callback,!1),canvas.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),document.addEventListener("keydown",this._keydown_callback,!1),document.addEventListener("keyup",this._keyup_callback,!1),this._events_binded=!0)}onKeyDown(t){for(const s in this.view.layers){let i=this.view.layers[s];i?.onKeyDown&&i.onKeyDown(t)}}onKeyUp(t){for(const s in this.view.layers){let i=this.view.layers[s];i?.onKeyUp&&i.onKeyUp(t)}}onMouseDown(t){let i=!1,e=Object.keys(this.view.layers).reverse();for(const s of e){const e=this.view.layers[s];e.extendMouseData(t),e?.onMouseDown&&(i=i||e.onMouseDown(t,i))}if(0==i){var n=void 0===t.isPrimary||!t.isPrimary;this.mouseStartCanvas=new s(t.canvasX,t.canvasY),this.mouseCurrentCanvas=this.mouseStartCanvas.clone(),this.pointerDown&&n?this.pointerIsDouble=!0:this.pointerIsDouble=!1,this.pointerDown=!0,this.canvas.focus(),1==t.which&&!this.pointerIsDouble&&this.dragable&&(this.draggingCanvas=!0),this.isMouseDown=!0}}onMouseMove(t){let s=!1,i=Object.keys(this.view.layers).reverse();for(const e of i){const i=this.view.layers[e];i.extendMouseData(t),this.mouseCurrentCanvas.x=t.canvasX,this.mouseCurrentCanvas.y=t.canvasY,i?.onMouseMove&&(s=s||i.onMouseMove(t,s))}var e=this.mouseCurrentCanvas.subtract(this.mouseStartCanvas);return t.dragging=this.isMouseDown,this.draggingCanvas&&(this.dx=e.x*this.scale,this.dy=e.y*this.scale,this.updateViewRect()),t.preventDefault(),!1}onMouseUp(t){t.stopPropagation(),t.preventDefault();let i=!1,e=Object.keys(this.view.layers).reverse();for(const h of e){const e=this.view.layers[h];e.extendMouseData(t),e.mouseCurrentCanvas=new s(t.canvasX,t.canvasY);var n=e.mouseCurrentCanvas.subtract(this.mouseStartCanvas);e?.onMouseUp&&(i=i||e.onMouseUp(t,i)),n.length()<.1&&e.onMouseClick&&e.onMouseClick(t)}if(0==i&&this.draggingCanvas){var h=void 0===t.isPrimary||t.isPrimary;if(this.node_mouse_down=null,!h)return!1;this.tx+=n.x*this.scale,this.ty+=n.y*this.scale,this.dx=0,this.dy=0,this.isMouseDown=!1,this.last_click_position=null,this.draggingCanvas=!1,h&&(this.pointerDown=!1,this.pointerIsDouble=!1),this.last_mouse=this.mouseCurrentCanvas}return!1}onMouseWheel(t){var s=null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail,i=this.view.scale;return s>0?i*=1.1:s<0&&(i*=1/1.1),this.view.setScale(i),t.preventDefault(),this.view.focusOn(),!1}}"undefined"!=typeof window&&(window.__NODICANVAS__?console.warn("WARNING: Multiple instances of nodicanvas.js being imported."):window.__NODICANVAS__=1),t.NodiGrid=n,t.NodiHud=class extends n{constructor(t,s){super(t),this.view=s}render(){const t=this.view.ctx;t.setTransform(1,0,0,1,0,0),t.font="20px Arial",t.fillStyle="black",t.fillText("Score: "+parseInt(this.view.point),60,30),this.msgText&&t.fillText(this.msgText,this.view.viewPort.width/2,30)}showMsg(t){this.msgText=t[0],setTimeout(this.removeText,t[1],this)}removeText(t){t.msgText=void 0}},t.NodiInput=h,t.NodiLayer=e,t.NodiView=class extends n{constructor(t,i,e){super("view",i,e),this.layers={},this.layerOrder=[],this.dragable=!1,this.setCanvas(t),this.draggingCanvas=!1,this.pointerDown=!1,this.pointerIsDouble=!1,this.viewPort=new DOMRect,this.startRendering(),this.center=new s(0,0),this.input=new h(this)}setCanvas(t){t&&t!==this.canvas&&(this.canvas=t,this.ctx=this.canvas.getContext("2d"))}getCanvasWindow(){if(!this.canvas)return window;var t=this.canvas.ownerDocument;return t.defaultView||t.parentWindow}startRendering(){this.isRendering||(this.isRendering=!0,function t(){this.render();var s=this.getCanvasWindow();this.isRendering&&s.requestAnimationFrame(t.bind(this))}.call(this))}stopRendering(){this.isRendering=!1}addLayer(t){t&&(t.attachView(this),this.layers[t.name]=t,this.layerOrder.push(t.name)),this.resize()}newLayer(t,s,i,e){const h=new n(t,s,i,e);return h.view=this,this.addLayer(h),h}render(){if(0!=this.canvas?.width&&0!=this.canvas?.height&&null!=this.ctx){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="lightgray",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.setTransform(this.sx,0,0,this.sy,this.tx+this.dx,this.ty+this.dy);for(const t of this.layerOrder){const s=this.layers[t];this.ctx.setTransform(this.sx,0,0,this.sy,this.tx+this.dx,this.ty+this.dy),this.ctx.transform(s.sx,0,0,s.sy,s.tx,s.ty),s.gridVisible&&s.renderGrid(this),s.visible&&s.render(this)}this.hud&&this.hud.render()}}resize(t,s){if(this.canvas.width!=t||this.canvas.height!=s){if(!t&&!s){var i=this.canvas.parentNode;t=i.offsetWidth,s=i.offsetHeight}this.canvas.width=t,this.canvas.height=s,this.focusOn(),this.updateViewPort(),this.updateViewRect(),this.focusOn()}}screenToWorld(t){return{x:(t.x-this.tx)/this.sx,y:(t.y-this.ty)/this.sy}}setScale(t){this.sx=t,this.sy=t,super.setScale(t)}setTranslate(t,s){this.tx=t,this.ty=s}focusOn(){var t=s.divide(new s(this.canvas.width,this.canvas.height),2);const i=s.subtract(s.multiply(this.center,this.sx),t);this.tx=-i.x,this.ty=-i.y}setCenter(t,s){this.center.x=t,this.center.y=s}updateViewRect(){for(const t in this.layers){this.layers[t].updateViewPort()}}},t.Transformation=i,t.Vec2=s,t.getRandomInt=function(t){return Math.floor(Math.random()*t)},Object.defineProperty(t,"__esModule",{value:!0})}));
